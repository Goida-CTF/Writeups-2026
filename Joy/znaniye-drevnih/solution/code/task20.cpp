#include "Ве_крест_крест.h"

внедрить хутор Русь;

целина беззнак(целина б)
{
    коли (б < 0) б = б + 256;
    воздать б;
}

целина длина_руны_по_первому_байту(целина б0)
{
    коли ((б0 & 128) == 0) воздать 1;
    коли ((б0 & 224) == 192) воздать 2;
    коли ((б0 & 240) == 224) воздать 3;
    коли ((б0 & 248) == 240) воздать 4;
    воздать 1;
}

целина код_руны(много_букав& строка, мерило начало, целина длина)
{
    целина б0 = беззнак(строка[начало]);

    коли (длина == 1) воздать б0;

    коли (длина == 2)
    {
        целина б1 = беззнак(строка[начало + 1]);
        воздать ((б0 & 31) << 6) | (б1 & 63);
    }

    коли (длина == 3)
    {
        целина б1 = беззнак(строка[начало + 1]);
        целина б2 = беззнак(строка[начало + 2]);
        воздать ((б0 & 15) << 12) | ((б1 & 63) << 6) | (б2 & 63);
    }

    // длина == 4
    целина б1 = беззнак(строка[начало + 1]);
    целина б2 = беззнак(строка[начало + 2]);
    целина б3 = беззнак(строка[начало + 3]);
    воздать ((б0 & 7) << 18) | ((б1 & 63) << 12) | ((б2 & 63) << 6) | (б3 & 63);
}

царь_батюшка_главный()
{
    вперёд_славяне;

    много_букав летопись;
    внемлить >> летопись;

    мерило всего = летопись.размер();

    // Хеш-таблица (открытая адресация), ключ = код_руны + 1 (0 значит пусто)
    целина размер = 262144;
    целина маска = размер - 1;

    целина ключ[262144];
    целина счёт[262144];
    мерило первый_номер[262144];
    мерило первый_байт[262144];
    целина первый_размер[262144];

    для (целина к = 0; к < размер; ++к)
    {
        ключ[к] = 0;
        счёт[к] = 0;
        первый_номер[к] = (мерило)0;
        первый_байт[к] = (мерило)0;
        первый_размер[к] = 0;
    }

    мерило номер_руны = 0;
    для (мерило место = 0; место < всего; )
    {
        целина б0 = беззнак(летопись[место]);
        целина дл = длина_руны_по_первому_байту(б0);
        коли (место + (мерило)дл > всего) дл = (целина)(всего - место);

        целина код = код_руны(летопись, место, дл);
        целина к = код + 1;

        // хеш
        целина х = (целина)((к * 2654435761u) & (целина)маска);

        покуда (ключ[х] != 0 && ключ[х] != к)
        {
            х = (х + 1) & маска;
        }

        коли (ключ[х] == 0)
        {
            ключ[х] = к;
            счёт[х] = 1;
            первый_номер[х] = номер_руны;
            первый_байт[х] = место;
            первый_размер[х] = дл;
        }
        отнюдь
        {
            счёт[х] = счёт[х] + 1;
        }

        место = место + (мерило)дл;
        номер_руны = номер_руны + 1;
    }

    // выбираем: максимум по счёту, при равенстве — меньший первый_номер
    целина лучший_счёт = -1;
    мерило лучший_номер = (мерило)0;
    мерило лучший_байт = (мерило)0;
    целина лучший_размер = 0;

    для (целина х = 0; х < размер; ++х)
    {
        коли (ключ[х] == 0) { /* пусто */ }
        отнюдь
        {
            коли (счёт[х] > лучший_счёт)
            {
                лучший_счёт = счёт[х];
                лучший_номер = первый_номер[х];
                лучший_байт = первый_байт[х];
                лучший_размер = первый_размер[х];
            }
            отнюдь коли (счёт[х] == лучший_счёт && первый_номер[х] < лучший_номер)
            {
                лучший_номер = первый_номер[х];
                лучший_байт = первый_байт[х];
                лучший_размер = первый_размер[х];
            }
        }
    }

    для (целина сдвиг = 0; сдвиг < лучший_размер; ++сдвиг)
    {
        молвить << летопись[лучший_байт + (мерило)сдвиг];
    }

    воздать ноль;
}
