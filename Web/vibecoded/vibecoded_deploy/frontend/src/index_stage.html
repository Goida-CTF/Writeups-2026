<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notes++ - ✨amazing✨ notes app</title>
    <link href="./styles.css" rel="stylesheet">
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
  </head>
  <body class="h-screen flex flex-col">
    <header class="bg-blue-600 text-white p-4 text-left">
      <h1 class="text-2xl font-bold">Notes++ - ✨amazing✨ notes app</h1>
      <div id="user-info" class="absolute right-4 top-4">
        <button id="logout" class="hidden bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-200">Logout</button>
      </div>
    </header>
    <div id="main" class="font-[sans-serif] bg-white flex items-center p-4 flex-1">
      <div id="auth-block" class="w-full max-w-5xl mx-auto">
        <div class="grid gap-4 bg-gray-50 shadow w-full py-6 relative">
          <div class="grid grid-cols-2 gap-4">
            <div class="grid mb-4 px-8">
              <h3 class="text-blue-500 text-2xl font-semibold">CREATE A NEW ACCOUNT</h3>
            </div>
            <div class="grid mb-4 px-8">
              <h3 class="text-blue-500 text-2xl font-semibold">LOG IN</h3>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <form class="grid px-8">
              <div class="space-y-4">
                <div class="relative flex items-center">
                  <input name="username" type="text" required class="bg-transparent border border-gray-400 w-full text-gray-800 text-sm pl-4 pr-10 py-2.5 rounded focus:border-black outline-none" placeholder="username" />
                  <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" stroke="#bbb" class="w-4 h-4 absolute right-4" viewBox="0 0 24 24">
                    <circle cx="10" cy="7" r="6" data-original="#000000"></circle>
                    <path d="M14 15H6a5 5 0 0 0-5 5 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 5 5 0 0 0-5-5zm8-4h-2.59l.3-.29a1 1 0 0 0-1.42-1.42l-2 2a1 1 0 0 0 0 1.42l2 2a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42l-.3-.29H22a1 1 0 0 0 0-2z" data-original="#000000"></path>
                  </svg>
                </div>
                <div class="relative flex items-center">
                  <input name="password" type="password" required class="bg-transparent border border-gray-400 w-full text-gray-800 text-sm pl-4 pr-10 py-2.5 rounded focus:border-black outline-none" placeholder="password" />
                  <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" stroke="#bbb" class="w-4 h-4 absolute right-4 cursor-pointer" viewBox="0 0 128 128">
                    <path d="M64 104C22.127 104 1.367 67.496.504 65.943a4 4 0 0 1 0-3.887C1.367 60.504 22.127 24 64 24s62.633 36.504 63.496 38.057a4 4 0 0 1 0 3.887C126.633 67.496 105.873 104 64 104zM8.707 63.994C13.465 71.205 32.146 96 64 96c31.955 0 50.553-24.775 55.293-31.994C114.535 56.795 95.854 32 64 32 32.045 32 13.447 56.775 8.707 63.994zM64 88c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm0-40c-8.822 0-16 7.178-16 16s7.178 16 16 16 16-7.178 16-16-7.178-16-16-16z" data-original="#000000"></path>
                  </svg>
                </div>
                <div class="relative flex items-center">
                  <input name="password-verify" type="password" required class="bg-transparent border border-gray-400 w-full text-gray-800 text-sm pl-4 pr-10 py-2.5 rounded focus:border-black outline-none" placeholder="verify password" />
                </div>
              </div>
            </form>
            <form class="grid px-8">
              <div class="space-y-4">
                <div class="relative flex items-center">
                  <input name="username" type="text" required class="bg-transparent border border-gray-400 w-full text-gray-800 text-sm pl-4 pr-10 py-2.5 rounded focus:border-black outline-none" placeholder="username" />
                  <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" stroke="#bbb" class="w-4 h-4 absolute right-4" viewBox="0 0 24 24">
                    <circle cx="10" cy="7" r="6" data-original="#000000"></circle>
                    <path d="M14 15H6a5 5 0 0 0-5 5 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 5 5 0 0 0-5-5zm8-4h-2.59l.3-.29a1 1 0 0 0-1.42-1.42l-2 2a1 1 0 0 0 0 1.42l2 2a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42l-.3-.29H22a1 1 0 0 0 0-2z" data-original="#000000"></path>
                  </svg>
                </div>
                <div class="relative flex items-center">
                  <input name="password" type="password" required class="bg-transparent border border-gray-400 w-full text-gray-800 text-sm pl-4 pr-10 py-2.5 rounded focus:border-black outline-none" placeholder="password" />
                  <svg xmlns="http://www.w3.org/2000/svg" fill="#bbb" stroke="#bbb" class="w-4 h-4 absolute right-4 cursor-pointer" viewBox="0 0 128 128">
                    <path d="M64 104C22.127 104 1.367 67.496.504 65.943a4 4 0 0 1 0-3.887C1.367 60.504 22.127 24 64 24s62.633 36.504 63.496 38.057a4 4 0 0 1 0 3.887C126.633 67.496 105.873 104 64 104zM8.707 63.994C13.465 71.205 32.146 96 64 96c31.955 0 50.553-24.775 55.293-31.994C114.535 56.795 95.854 32 64 32 32.045 32 13.447 56.775 8.707 63.994zM64 88c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm0-40c-8.822 0-16 7.178-16 16s7.178 16 16 16 16-7.178 16-16-7.178-16-16-16z" data-original="#000000"></path>
                  </svg>
                </div>
                <div class="flex items-center mb-4">
                  <input id="rememberme" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                  <label for="rememberme" class="ms-2 text-sm font-medium text-gray-900">Remember me</label>
              </div>
              </div>
            </form>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div id="place1" class="grid px-8">
              <div id="captcha1"></div>
              <div>
                <p id="error1" class='text-red-600 text-sm'></p>
              </div>
            </div>
            <div id="place2" class="grid px-8">
              <div id="captcha2"></div>
              <div>
                <p id="error2" class='text-red-600 text-sm'></p>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="grid px-8">
              <button id="register" type="button" class="w-full py-2.5 px-4 text-sm tracking-wide rounded bg-blue-600 hover:bg-blue-700 text-white focus:outline-none">Register</button>
            </div>
            <div class="grid px-8">
              <button id="login" type="button" class="w-full py-2.5 px-4 text-sm tracking-wide rounded bg-blue-600 hover:bg-blue-700 text-white focus:outline-none">Log in</button>
            </div>
          </div>
          <div class="divider absolute left-0 right-0 mx-auto w-1 h-full border-l border-gray-400"></div>
        </div>
      </div>
    </div>
  </body>
  <script>
    let loggedIn = false;

    function showCaptcha(containerId, callback) {
      const container = document.getElementById(containerId);
      container.innerHTML = '<div class="h-captcha" data-sitekey="__HCAPTCHA_SITEKEY__" data-callback="onCaptcha"></div>';
      hcaptcha.render(containerId, {
        sitekey: "__HCAPTCHA_SITEKEY__",
        callback: callback
      });
    }

    function setAuthUI(isLoggedIn) {
      document.getElementById('logout').classList.toggle('hidden', !isLoggedIn);
      document.getElementById('auth-block').classList.toggle('hidden', isLoggedIn);
    }

    document.getElementById('logout').addEventListener('click', async () => {
      await fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      });
      window.location.reload();
    });

    window.onload = () => {
      fetch('/api/posts', {
        method: 'GET',
        credentials: 'include',
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'ok') {
          setAuthUI(true);
          loadPosts();
        } else {
          setAuthUI(false);
        }
      })
      .catch(() => setAuthUI(false));
    };

    document.getElementById('register').addEventListener('click', async function () {
      let username = document.querySelector('form:first-of-type input[name="username"]').value.trim();
      let password = document.querySelector('form:first-of-type input[name="password"]').value.trim();
      let passwordVerify = document.querySelector('form:first-of-type input[name="password-verify"]').value.trim();
      let error1 = document.getElementById('error1');
      error1.innerHTML = "";

      if (username === "" || password === "" || passwordVerify === "") {
        error1.innerHTML = "Please fill in all fields";
        return;
      }

      if (password !== passwordVerify) {
        error1.innerHTML = "Passwords do not match";
        return;
      }

      const complexityRes = await fetch('/api/check-password-complexity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      const complexityData = await complexityRes.json();

      if (!complexityData.data.ok) {
        let levelLabel = "";
        switch (complexityData.data.level) {
          case 1: levelLabel = "Weak password"; break;
          case 2: levelLabel = "Normal password"; break;
          case 3: levelLabel = "Too strong password"; break;
        }
        error1.innerHTML = `${levelLabel}: ${complexityData.data.text}`;
        return;
      }

      showCaptcha("captcha1", async (token) => {
        document.cookie = `_c=${token}; path=/`;

        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (data.status === "ok") {
          error1.innerHTML = "Registration successful!";
        } else {
          error1.innerHTML = data.error;
        }
      });
    });

    document.getElementById('login').addEventListener('click', function () {
      let username = document.querySelector('form:last-of-type input[name="username"]').value.trim();
      let password = document.querySelector('form:last-of-type input[name="password"]').value.trim();
      let error2 = document.getElementById('error2');
      error2.innerHTML = "";

      if (username === "" || password === "") {
        error2.innerHTML = "Please fill in all fields";
        return;
      }

      showCaptcha("captcha2", async (token) => {
        document.cookie = `_c=${token}; path=/`;

        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (data.status === "ok") {
          error2.innerHTML = "";
          setAuthUI(true);
          loadPosts();
        } else {
          error2.innerHTML = data.error;
        }
      });
    });
</script>
<script>
function loadPosts() {
  fetch('/api/posts', {
    method: 'GET',
    credentials: 'include',
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'ok') {
      const posts = data.data;
      const main = document.getElementById('main');
      main.innerHTML = `
        <div class="w-full max-w-5xl mx-auto p-4">
          <h2 class="text-2xl font-semibold mb-4">Posts</h2>
          <div class="space-y-4">
            ${posts.map(post => `
              <div class="p-4 border border-gray-300 rounded shadow">
                <h3 class="text-xl font-bold">${post.title}</h3>
                <p class="mt-2 text-gray-700">${post.content}</p>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    } else {
      alert("Failed to load posts: " + data.error);
    }
  });
}
</script>
</html>
